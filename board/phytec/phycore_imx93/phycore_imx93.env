/* SPDX-License-Identifier: (GPL-2.0+ OR MIT) */

#include <environment/phytec/rauc.env>
#include <environment/phytec/fit.env>

image=Image
console=ttyLP0
fdt_addr=0x90000000
fdto_addr=0x900c0000
bootenv_addr=0x90500000
fdt_file=CONFIG_DEFAULT_FDT_FILE
ipaddr=192.168.3.11
serverip=192.168.3.10
netmask=255.255.255.0
ip_dyn=no
bootenv=bootenv.txt
prepare_mcore=setenv mcore_clk clk-imx93.mcore_booted;
mmc_load_bootenv=fatload mmc ${mmcdev}:${mmcpart} ${bootenv_addr} ${bootenv}
sd_dev=1
emmc_dev=0
mmcdev=__stringify(CONFIG_SYS_MMC_ENV_DEV)
mmcpart=1
mmcroot=2
mmcautodetect=yes
mmcargs=setenv bootargs ${mcore_clk} console=${console},${baudrate} earlycon
	root=/dev/mmcblk${mmcdev}p${mmcroot} ${raucargs} rootwait rw
loadimage=fatload mmc ${mmcdev}:${mmcpart} ${loadaddr} ${image}
loadfdt=fatload mmc ${mmcdev}:${mmcpart} ${fdt_addr} ${fdt_file}
mmc_load_overlay=fatload mmc ${mmcdev}:${mmcpart} ${fdto_addr} ${overlay}
mmc_apply_overlays=
	fdt address ${fdt_addr};
	if test ${no_extensions} = 0; then
		setenv extension_overlay_addr ${fdto_addr};
		setenv extension_overlay_cmd 'fatload mmc ${mmcdev}:${mmcpart}
			${fdto_addr} ${extension_overlay_name}';
		extension scan;
		extension apply all;
	fi;
	if test ${no_overlays} = 0; then
		for overlay in ${overlays};
		do;
			if run mmc_load_overlay; then
				fdt resize ${filesize};
				fdt apply ${fdto_addr};
			fi;
		done;
	fi;
mmcboot=
	echo Booting from mmc ...;
	if test ${no_bootenv} = 0; then
		if run mmc_load_bootenv; then
			env import -t ${bootenv_addr} ${filesize};
		fi;
	fi;
	run mmcargs;
	if test ${dofitboot} = 1; then
		run fitboot;
	fi;
	if run loadfdt; then
		run mmc_apply_overlays;
		booti ${loadaddr} - ${fdt_addr};
	else
		echo WARN: Cannot load the DT;
	fi;
nfsroot=/nfs
netargs=setenv bootargs ${mcore_clk} console=${console},${baudrate} earlycon
	root=/dev/nfs ip=${nfsip} nfsroot=${serverip}:${nfsroot},v3,tcp
net_load_bootenv=${get_cmd} ${bootenv_addr} ${bootenv}
net_load_overlay=${get_cmd} ${fdto_addr} ${overlay}
net_apply_overlays=
	fdt address ${fdt_addr};
	if test ${no_extensions} = 0; then
		setenv extension_overlay_addr ${fdto_addr};
		setenv extension_overlay_cmd '${get_cmd}
			${fdto_addr} ${extension_overlay_name}';
		extension scan;
		extension apply all;
	fi;
	if test ${no_overlays} = 0; then
		for overlay in ${overlays};
		do;
			if run net_load_overlay; then
				fdt resize ${filesize};
				fdt apply ${fdto_addr};
			fi;
		done;
	fi;
netboot=
	echo Booting from net ...;
	if test ${ip_dyn} = yes; then
		setenv nfsip dhcp;
		setenv get_cmd dhcp;
	else
		setenv nfsip ${ipaddr}:${serverip}::${netmask}::eth0:on;
		setenv get_cmd tftp;
	fi;
	if test ${no_bootenv} = 0; then
		if run net_load_bootenv; then
			env import -t ${bootenv_addr} ${filesize};
		fi;
	fi;
	run netargs;
	${get_cmd} ${loadaddr} ${image};
	if ${get_cmd} ${fdt_addr} ${fdt_file}; then
		run net_apply_overlays;
		booti ${loadaddr} - ${fdt_addr};
	else
		echo WARN: Cannot load the DT;
	fi;
